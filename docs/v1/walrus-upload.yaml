paths:
  /walrus/upload:
    post:
      summary: Upload encrypted file to Walrus
      description: |
        **Purpose**: Upload encrypted financial documents to Walrus decentralized storage.

        **Upload Relay Pattern**:
        - This endpoint acts as an upload relay to reduce browser HTTP requests
        - Direct Walrus uploads from browser require ~2000 requests due to erasure coding
        - This relay consolidates requests: browser → backend → Walrus (1 request from browser)

        **Encryption Modes**:
        - `client_encrypted`: File encrypted by frontend using @mysten/seal SDK before upload (recommended)
        - `server_encrypted`: Backend encrypts file using Seal (requires ENABLE_SERVER_ENCRYPTION=true)

        **Workflow**:
        1. Frontend encrypts file using Seal SDK (or sends plaintext for server encryption)
        2. Uploads via multipart/form-data to this endpoint
        3. Backend uploads to Walrus aggregator
        4. Returns blobId + transaction to register blob on-chain
        5. Frontend signs and executes transaction to link blob to deal

        **Access Control**:
        - Authentication required: User must provide valid Sui signature
        - Authorization: User must be a participant in the deal (buyer/seller/auditor)
      operationId: uploadToWalrus
      tags:
        - Walrus
        - File Upload
      parameters:
        - name: mode
          in: query
          required: false
          schema:
            type: string
            enum: [client_encrypted, server_encrypted]
            default: client_encrypted
          description: |
            Encryption mode:
            - `client_encrypted`: File already encrypted by frontend (recommended)
            - `server_encrypted`: Backend will encrypt file (requires feature flag)
          example: client_encrypted
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui wallet address of the uploader
        - name: X-Sui-Signature
          in: header
          required: true
          schema:
            type: string
          description: Base64-encoded signature of the timestamp message
        - name: X-Sui-Signature-Message
          in: header
          required: true
          schema:
            type: string
            format: date-time
          description: |
            ISO timestamp that was signed (e.g., "2025-11-20T10:30:45.123Z").
            Must be within 5 minutes of current time to prevent replay attacks.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - dealId
                - periodId
                - dataType
              properties:
                file:
                  type: string
                  format: binary
                  description: |
                    File to upload (encrypted ciphertext or plaintext depending on mode).

                    **Client Encrypted Mode**: Send encrypted file bytes
                    **Server Encrypted Mode**: Send plaintext file bytes
                dealId:
                  type: string
                  pattern: '^0x[a-fA-F0-9]{64}$'
                  description: Deal ID this file belongs to
                  example: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
                periodId:
                  type: string
                  description: Period ID this file belongs to
                  example: "period_2026"
                dataType:
                  type: string
                  enum:
                    - revenue_journal
                    - ebitda_report
                    - expense_report
                    - balance_sheet
                    - cash_flow
                    - kpi_calculation
                    - audit_report
                    - custom
                  description: Type of financial document being uploaded
                  example: revenue_journal
                customDataType:
                  type: string
                  description: Custom data type name (required if dataType is 'custom')
                  example: "Customer Acquisition Cost Report"
                filename:
                  type: string
                  description: Original filename
                  example: "revenue_q1_2026.csv"
                description:
                  type: string
                  maxLength: 500
                  description: Optional description of the file contents
                  example: "Q1 2026 revenue journal with transaction details"
            encoding:
              file:
                contentType: application/octet-stream
      responses:
        '200':
          description: File uploaded successfully to Walrus
          content:
            application/json:
              schema:
                $ref: '../schemas/walrus.yaml#/components/schemas/WalrusUploadResponse'
              example:
                blobId: "blob_2Nf8pQz3Xm7Yk5Rd9Wv1Bc6Lt4Hs"
                commitment: "sha256:a1b2c3d4e5f6789abcdef123456789"
                size: 2048576
                uploadedAt: "2026-03-15T09:30:00Z"
                nextStep:
                  action: "register_on_chain"
                  description: "Call POST /api/v1/deals/{dealId}/periods/{periodId}/blobs to register this blob on-chain"
                  transaction:
                    txBytes: "AAACAAgQJxAAAAAAAAAgx7VRE4..."
                    description: "Register Walrus blob: revenue_journal for period_2026"
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ValidationError'
              examples:
                invalidMode:
                  value:
                    error: "ValidationError"
                    message: "Invalid encryption mode. Must be one of: client_encrypted, server_encrypted"
                    statusCode: 400
                    details:
                      providedMode: "invalid_mode"
                      validModes: ["client_encrypted", "server_encrypted"]
                missingFile:
                  value:
                    error: "ValidationError"
                    message: "File is required"
                    statusCode: 400
        '401':
          description: Unauthorized - Missing or invalid authentication
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ForbiddenError'
              examples:
                serverEncryptionDisabled:
                  value:
                    error: "ForbiddenError"
                    message: "Server-side encryption is disabled"
                    statusCode: 403
                    details:
                      reason: "ENABLE_SERVER_ENCRYPTION is set to false"
                      suggestion: "Use mode=client_encrypted or enable server encryption in configuration"
                notParticipant:
                  value:
                    error: "ForbiddenError"
                    message: "User is not authorized to upload files for this deal"
                    statusCode: 403
        '413':
          description: Payload too large - File size exceeds maximum allowed
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ErrorResponse'
              example:
                error: "PayloadTooLarge"
                message: "File size exceeds maximum allowed size"
                statusCode: 413
                details:
                  maxSize: "100MB"
                  providedSize: "150MB"
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ErrorResponse'
              examples:
                walrusError:
                  value:
                    error: "WalrusError"
                    message: "Failed to upload file to Walrus"
                    statusCode: 500
                    details:
                      reason: "Walrus aggregator unavailable"
                encryptionError:
                  value:
                    error: "EncryptionError"
                    message: "Failed to encrypt file"
                    statusCode: 500
