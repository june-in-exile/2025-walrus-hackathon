paths:
  /walrus/upload:
    post:
      summary: Upload encrypted file to Walrus
      description: |
        **Purpose**: Upload encrypted financial documents to Walrus decentralized storage.

        **Upload Relay Pattern**:
        - This endpoint acts as an upload relay to reduce browser HTTP requests
        - Direct Walrus uploads from browser require ~2000 requests due to erasure coding
        - This relay consolidates requests: browser → backend → Walrus (1 request from browser)

        **Encryption Modes**:
        - `client_encrypted`: File encrypted by frontend using @mysten/seal SDK before upload (recommended)
        - `server_encrypted`: Backend encrypts file using Seal (requires ENABLE_SERVER_ENCRYPTION=true)

        **Workflow**:
        1. Frontend encrypts file using Seal SDK (or sends plaintext for server encryption)
        2. Uploads via multipart/form-data to this endpoint
        3. Backend uploads to Walrus aggregator
        4. Returns blobId + transaction to register blob on-chain
        5. Frontend signs and executes transaction to link blob to deal

        **Access Control**:
        - Authentication required: User must provide valid Sui signature
        - Authorization: User must be a participant in the deal (buyer/seller/auditor)
      operationId: uploadToWalrus
      tags:
        - Walrus
      parameters:
        - name: mode
          in: query
          required: false
          schema:
            type: string
            enum: [client_encrypted, server_encrypted]
            default: client_encrypted
          description: |
            Encryption mode:
            - `client_encrypted`: File already encrypted by frontend (recommended)
            - `server_encrypted`: Backend will encrypt file (requires feature flag)
          example: client_encrypted
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui wallet address of the uploader
        - name: X-Sui-Signature
          in: header
          required: true
          schema:
            type: string
          description: Base64-encoded signature of the timestamp message
        - name: X-Sui-Signature-Message
          in: header
          required: true
          schema:
            type: string
            format: date-time
          description: |
            ISO timestamp that was signed (e.g., "2025-11-20T10:30:45.123Z").
            Must be within 5 minutes of current time to prevent replay attacks.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - dealId
                - periodId
                - dataType
              properties:
                file:
                  type: string
                  format: binary
                  description: |
                    File to upload (encrypted ciphertext or plaintext depending on mode).

                    **Client Encrypted Mode**: Send encrypted file bytes
                    **Server Encrypted Mode**: Send plaintext file bytes
                dealId:
                  type: string
                  pattern: '^0x[a-fA-F0-9]{64}$'
                  description: Deal ID this file belongs to
                  example: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
                periodId:
                  type: string
                  description: Period ID this file belongs to
                  example: "period_2026"
                dataType:
                  type: string
                  enum:
                    - revenue_journal
                    - ebitda_report
                    - expense_report
                    - balance_sheet
                    - cash_flow
                    - kpi_calculation
                    - audit_report
                    - custom
                  description: Type of financial document being uploaded
                  example: revenue_journal
                customDataType:
                  type: string
                  description: Custom data type name (required if dataType is 'custom')
                  example: "Customer Acquisition Cost Report"
                filename:
                  type: string
                  description: Original filename
                  example: "revenue_q1_2026.csv"
                description:
                  type: string
                  maxLength: 500
                  description: Optional description of the file contents
                  example: "Q1 2026 revenue journal with transaction details"
            encoding:
              file:
                contentType: application/octet-stream
      responses:
        '200':
          description: File uploaded successfully to Walrus
          content:
            application/json:
              schema:
                $ref: '../schemas/walrus.yaml#/components/schemas/WalrusUploadResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ValidationError'
        '401':
          description: Unauthorized - Missing or invalid authentication
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ForbiddenError'
        '413':
          description: Payload too large - File size exceeds maximum allowed
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ErrorResponse'

  /walrus/download/{blobId}:
    get:
      summary: Download encrypted file from Walrus
      description: |
        **Purpose**: Download encrypted financial documents from Walrus storage.

        **Encryption & Decryption**:
        - Files are stored encrypted on Walrus
        - Backend downloads and returns encrypted blob
        - **Frontend is responsible for decryption** using @mysten/seal SDK
        - Response headers provide Seal policy info needed for decryption

        **Access Control**:
        - User must be authenticated with Sui signature
        - User must be a participant in the specified deal
        - Seal policy determines who can decrypt (buyer/seller/auditor)
        - Different roles may have different decryption capabilities

        **Decryption Workflow** (Frontend):
        1. Receive encrypted blob from this endpoint
        2. Extract Seal policy info from response headers (X-Seal-Package-Id, X-Seal-Whitelist-Id)
        3. Initialize Seal SDK with policy
        4. Call seal.decrypt() to get plaintext
        5. Present decrypted file to user

        **Why dealId Required**:
        - Authorization check: Verify user is a deal participant
        - Seal policy lookup: Determine which decryption keys to use
        - Audit trail: Log who accessed which deal's files
      operationId: downloadFromWalrus
      tags:
        - Walrus
      parameters:
        - name: blobId
          in: path
          required: true
          schema:
            type: string
          description: |
            Walrus blob identifier (returned from upload endpoint)
          example: "blob_2Nf8pQz3Xm7Yk5Rd9Wv1Bc6Lt4Hs"
        - name: dealId
          in: query
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: |
            Deal ID for authorization and policy lookup.
            Required to verify user has permission to access this blob.
          example: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui wallet address of the requester
        - name: X-Sui-Signature
          in: header
          required: true
          schema:
            type: string
          description: Base64-encoded signature of the timestamp message
        - name: X-Sui-Signature-Message
          in: header
          required: true
          schema:
            type: string
            format: date-time
          description: |
            ISO timestamp that was signed (e.g., "2025-11-20T10:30:45.123Z").
            Must be within 5 minutes of current time to prevent replay attacks.
      responses:
        '200':
          description: Encrypted blob downloaded successfully
          headers:
            X-Seal-Package-Id:
              description: Seal package ID for decryption
              schema:
                type: string
              example: "0xseal_package_000000000000000000000000000000000000000000000000"
            X-Seal-Whitelist-Id:
              description: Seal whitelist object ID for access control verification
              schema:
                type: string
              example: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
            Content-Type:
              description: Always application/octet-stream for encrypted binary data
              schema:
                type: string
                enum: [application/octet-stream]
            Content-Length:
              description: Size of encrypted blob in bytes
              schema:
                type: integer
              example: 2048576
            Content-Disposition:
              description: Suggests filename for download (attachment; filename="encrypted_blob")
              schema:
                type: string
              example: 'attachment; filename="blob_2Nf8pQz3Xm7Yk5Rd9Wv1Bc6Lt4Hs.enc"'
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
                description: |
                  Encrypted file contents (ciphertext).
                  Frontend must decrypt using Seal SDK with provided policy headers.
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ValidationError'
        '401':
          description: Unauthorized - Missing or invalid authentication
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '403':
          description: Forbidden - User not authorized to access this blob
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ForbiddenError'
        '404':
          description: Blob not found
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/NotFoundError'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ErrorResponse'
